<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è§£é¡Œçµ±è¨ˆè³‡æ–™ - PDAO Admin</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
    // CSV ä¸‹è¼‰åŠŸèƒ½
    function download_pro_csv() {
      let csv = 'ID,Label,Name,Solved,First Solved,Dept.,Time\n';
      $('#problem-stats tr').each(function (i) {
        const cols = $(this).find('td').map((_, td) => $(td).text().trim()).get();
        csv += cols.join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'problem_stats.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // éšŠä¼çµ±è¨ˆ CSV ä¸‹è¼‰åŠŸèƒ½
    function download_team_csv() {
      let csv = 'ID,Name,Dept.,Solved,Total Attempt,Penalty,Rank\n';
      $('#team-stats tr').each(function (i) {
        const cols = $(this).find('td').map((_, td) => $(td).text().trim()).get();
        csv += cols.join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'team_stats.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</head>
<body style="height: 100%; overflow: hidden; display: flex; flex-direction: column;"">
    <nav class="navbar navbar-light bg-light shadow-sm mb-4 px-4" >
        <div class="container-fluid">
          <a class="navbar-brand mb-0 h4" href="{{ url_for('index') }}">ğŸˆ PDAO Admin</a>
          <div class="d-flex gap-4">
            <div style="width: 3px; background-color: #ccc;"></div>
            <a class="nav-link text-dark fw-bold" href="{{ url_for('index') }}">ğŸ  ä¸»ç•«é¢</a>
            <div style="width: 1px; background-color: #ccc;"></div>
            <a class="nav-link text-dark fw-bold" href="{{url_for('stat', sec='pro')}}">ğŸ“˜ é¡Œç›®è§£é¡Œçµ±è¨ˆ</a>
            <div style="width: 1px; background-color: #ccc;"></div>
            <a class="nav-link text-dark fw-bold" href="{{url_for('stat', sec='team')}}">ğŸ‘¥ éšŠä¼è§£é¡Œçµ±è¨ˆ</a> 
            <div style="width: 1px; background-color: #ccc;"></div>
          </div>
          <div class="ms-auto d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#accountModal">
              æ‚¨å¥½ï¼Œ{{ current_user }}
            </button>
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('logout') }}">ç™»å‡º</a>
          </div>
        </div>
    </nav>

    <div class="container-fluid px-5 flex-grow-1">
        <div id="problem-stats-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">ğŸ“˜ é¡Œç›®è§£é¡Œçµ±è¨ˆ</h4>
                <div class="ms-auto d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" onclick="renderRuns();">æ›´æ–°</button>
                  <button class="btn btn-outline-success btn-sm" onclick="download_pro_csv();">ä¸‹è¼‰ CSV</button>
                </div>
            </div>
            <div class="table-responsive" style="height: 80vh; overflow-y: auto; overflow-x: hidden; min-height: 200px;">
                <table class="table table-bordered text-center align-middle table-sm" style="width: 100%;">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 1; background-color: #f8f9fa;">
                  <tr>
                    <th class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">ID</th>
                    <th class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Label</th>
                    <th class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Name</th>
                    <th class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Solved</th>
                    <th class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">First Solved</th>
                    <th class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Dept.</th>
                    <th class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Time</th>
                  </tr>
                </thead>
                <tbody id="problem-stats"></tbody>
                </table>
            </div>
        </div>

        <div id="team-stats-container" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex align-items-center gap-3">
                <h4 class="mb-0">ğŸ‘¥ éšŠä¼è§£é¡Œçµ±è¨ˆ</h4>
                <select id="sort-mode" class="form-select form-select-sm w-auto">
                  <option value="id">ä¾IDæ’åº</option>
                  <option value="rank">ä¾æ’åæ’åº</option>
                </select>
              </div>
              <div class="ms-auto d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" onclick="renderRuns();">æ›´æ–°</button>
                <button class="btn btn-outline-success btn-sm" onclick="download_team_csv();">ä¸‹è¼‰ CSV</button>
              </div>
            </div>
            <div class="table-responsive" style="height: 80vh; overflow-y: auto;">
                <table class="table table-bordered text-center align-middle">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 1; background-color: #f8f9fa;">
                  <tr>
                    <th class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">ID</th>
                    <th class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Name</th>
                    <th class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Dept.</th>
                    <th class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Solved</th>
                    <th class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Total Attempt</th>
                    <th class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Penalty</th>
                    <th class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Rank</th>
                  </tr>
                </thead>
                <tbody id="team-stats"></tbody>
                </table>
            </div>
        </div>
   </div>

  <script>
    const contestData = {{ contest_data | tojson }};
    const reqSec = "{{ req_sec }}";
    const problems = {};
    const teams = {};
    var teamStats = {};
    contestData.problems.forEach(p => {problems[p.id] = p;});
    contestData.teams.forEach(t => {teams[t.id] = t;});

    function chk_login(){
      $.getJSON("{{ url_for('login_status') }}", function (res) {
        if (!res.logged_in) {
          alert("è«‹ç™»å…¥ï¼");
          window.location.href = "{{ url_for('login') }}";
        }
      });
    }
    $(chk_login);
    setInterval(chk_login, 1000); // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ç™»å…¥ç‹€æ…‹

    function sec(id) {
      if (id === 'pro') {
        $('#problem-stats-container').show();
        $('#team-stats-container').hide();
      } else if (id === 'team') {
        $('#problem-stats-container').hide();
        $('#team-stats-container').show();
      }
    }
    $(sec(reqSec));

    function renderRuns(){
      $.ajax({
        url: "{{ url_for('api-runs') }}",
        method: "GET",
        dataType: "json",
        success: function (res) {
          const runs = res.data.runs || {};
          const SolvedSet = new Set();
          const problemStats = {};
          contestData.teams.forEach(t => {teamStats[t.id] = {solved: 0, attempts: 0, penalty: 0, rank: 0};});
          runs.forEach(run => {
            const pid = run.problem;
            const tid = run.team;
            const probMeta = problems[pid];
            const teamMeta = teams[tid];
            const plabel = probMeta.name;
            const pname = probMeta.title;
            const tname = teamMeta.name;
            const tpos = teamMeta.position;

            // é¡Œç›®çµ±è¨ˆ
            if(run.result && run.result.startsWith("Yes")) {
              if (!problemStats[pid])
                problemStats[pid] = {solves: 1, first: tname, ftime: run.submissionTime};
              else if(!SolvedSet.has((pid, tid)))
                problemStats[pid].solves++;
            }

            // éšŠä¼çµ±è¨ˆ
            if (run.result && run.result.startsWith("Yes")) {
              if(!SolvedSet.has((pid, tid))) {
                SolvedSet.add((pid, tid));
                teamStats[tid].solved++;
                teamStats[tid].penalty += run.submissionTime + teamStats[tid].attempts * 20;
              }
            } else if(!SolvedSet.has((pid, tid)))
              teamStats[tid].attempts++;
          });

          // Render é¡Œç›®çµ±è¨ˆ
          $('#problem-stats').empty();
          Object.entries(contestData.problems).forEach(([pid, p]) => {
            const pStats = problemStats[p.id] || { solves: 0, first: '-', ftime: '-' };
            const tName = (pStats.first != '-' ?pStats.first.match(/^([^()]+)\(([^()]*)\)$/):['-','-','-']);
            $('#problem-stats').append(`
              <tr>
                <td class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${p.id}</td>
                <td class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${p.name}</td>
                <td class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 30vw;">${p.title}</td>
                <td class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${pStats.solves}</td>
                <td class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 40vw;">${tName[1]}</td>
                <td class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${tName[2]}</td>
                <td class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${pStats.ftime}</td>
              </tr>
            `);
          });
          calculateRank();
          renderTeamTable();
        },
        error: function (xhr) {
          if (xhr.status === 500) {
            console.warn('Server error 500, retrying...');
            setTimeout(() => renderRuns(), 1000);
          } else
            alert('è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\n' + xhr.status + ': ' + xhr.statusText);
        }
      });
    }
    $(renderRuns);

    // è¨ˆç®—æ’å
    function calculateRank() {
      const sortedTeams = Object.entries(teamStats).sort((a, b) => {
        if (a[1].solved !== b[1].solved) {
          return b[1].solved - a[1].solved;
        } else if (a[1].penalty !== b[1].penalty) {
          return a[1].penalty - b[1].penalty;
        } else {
          return a[0].localeCompare(b[0]);
        }
      });
      var rank = 1, prevSolved = -1, prevPenalty = -1;
      sortedTeams.forEach((team, index) => {
        if (team[1].solved !== prevSolved || team[1].penalty !== prevPenalty) {
          rank = index + 1;
          prevSolved = team[1].solved;
          prevPenalty = team[1].penalty;
        }
        teamStats[team[0]].rank = rank;
      });
    }

    // Render éšŠä¼çµ±è¨ˆ
    function renderTeamTable() {
      $('#team-stats').empty();
      const method = $('#sort-mode').val();
      const teamEntries = Object.entries(teamStats).sort((a, b) => {
        if (method === 'rank') {
          return a[1].rank - b[1].rank;
        } else {
          return a[0].localeCompare(b[0]);
        }
      });
      teamEntries.forEach(([tid, t]) => {
        const tName = teams[tid].name.match(/^([^()]+)\(([^()]*)\)$/);
        $('#team-stats').append(`
          <tr>
            <td class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${tid}</td>
            <td class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 40vw;">${tName[1]}</td>
            <td class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${tName[2]}</td>
            <td class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${t.solved}</td>
            <td class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${t.attempts}</td>
            <td class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${t.penalty}</td>
            <td class="text-truncate" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${t.rank}</td>
          </tr>
        `);
      });
    }

    $('#sort-mode').on('change', function () { renderTeamTable();});
  
  </script>
</body>
</html>
