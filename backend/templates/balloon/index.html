<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ°£çƒåˆ†ç™¼ - PDAO Admin</title>
  <link rel="icon" href="{{ url_for('static', filename='balloon/pdaologo.ico') }}" type="image/x-icon">
  <link rel="stylesheet" href="{{ url_for('static', filename='balloon/style.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

  <nav class="navbar navbar-light bg-light shadow-sm mb-4 px-4">
    <div class="container-fluid">
      <a class="navbar-brand mb-0 h4" href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='balloon/pdaologo.ico') }}" alt="PDAO Logo" style="height: 1em; vertical-align: -0.1em;"> PDAO Admin</a>
      <div class="d-flex gap-3">
        <div style="width: 3px; background-color: #ccc;"></div>
        <a class="nav-link text-dark fw-bold" href="{{ url_for('index') }}">ğŸˆæ°£çƒåˆ†ç™¼</a>
        <div style="width: 1px; background-color: #ccc;"></div>
        <a class="nav-link text-dark fw-bold" href="{{url_for('stat', sec='pro')}}">ğŸ“˜é¡Œç›®çµ±è¨ˆ</a>
        <div style="width: 1px; background-color: #ccc;"></div>
        <a class="nav-link text-dark fw-bold" href="{{url_for('stat', sec='team')}}">ğŸ‘¥éšŠä¼çµ±è¨ˆ</a> 
        <div style="width: 1px; background-color: #ccc;"></div>
      </div>
      <div class="ms-auto d-flex gap-2">
        <div id="remaining-time" class="badge bg-warning text-dark px-3 py-2 fs-6 fw-bold">
          å‰©é¤˜æ™‚é–“ï¼šè¼‰å…¥ä¸­...
        </div>
        <div style="width: 1px; background-color: #ccc;"></div>
        <div class="form-check form-switch d-flex align-items-center">
          <input class="form-check-input" type="checkbox" id="frozenSwitch"/>
          <label class="form-check-label ms-2" for="frozenSwitch">è¨˜åˆ†æ¿å°æ¿</label>
        </div>
        <div style="width: 1px; background-color: #ccc;"></div>
        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#accountModal">
          æ‚¨å¥½ï¼Œ{{ current_user }}
        </button>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('logout') }}">ç™»å‡º</a>
      </div>
    </div>
  </nav>
  

<div class="container-flex">
  <div class="left-scrollable">
    <div class="ms-auto d-flex gap-2" style="overflow: hidden;">
      <button class="btn btn-outline-primary btn-sm fil_all selected" onclick="filter_all();">å…¨éƒ¨</button>
      <button class="btn btn-outline-primary btn-sm fil_sent" onclick="filter_sent();">æœªé€å‡º</button>
      <button class="btn btn-outline-primary btn-sm fil_made" onclick="filter_made();">æœªè£½ä½œ</button>
    </div>
    <table id="balloon_rec" class="table table-bordered align-middle text-center bg-white" style="display: none;">
      <thead class="table-light" style="position: sticky; top: 0; z-index: 10; background-color: white;">
        <tr>
          <th>ID</th>
          <th>éšŠå</th>
          <th>å€åŸŸ</th>
          <th>åº§ä½</th>
          <th>é¡Œè™Ÿ</th>
          <th>é¡è‰²</th>
          <th>è£½ä½œğŸˆ</th>
          <th>é€å‡ºğŸˆ</th>
        </tr>
      </thead>
      <tbody id="runs-body"></tbody>
    </table>
    <div id="loading" class="d-flex flex-column justify-content-center align-items-center" style="height: 80vh;">
      <div class="spinner-border text-primary" role="status"></div>
      <span class="mt-3 fw-bold">Loading...</span>
    </div>
  </div>
  <div class="right-scrollable">
    <h4 class="text-center mb-2">
      <span style="font-weight: bold;">è¬›å°</span>
      <button class="btn btn-sm btn-outline-secondary" style="float: right; margin-left: 0.5rem;" onclick="SelectReset();">é‡ç½®</button>
    </h4>
    <div style="display: flex; justify-content: center; align-items: center;">
      <table class="table table-bordered text-center align-middle m-0"
             style="padding: 0;table-layout: fixed; width: 100%; height: 100%;
                    font-size: 1rem; font-weight: bold;">
        <tbody id="seating-map" style="padding: 0;"></tbody>
      </table>
    </div>
  </div>  
  <!-- å¸³è™Ÿç®¡ç† Modal -->
  <div class="modal fade" id="accountModal" tabindex="-1" aria-labelledby="accountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="accountForm">
          <div class="modal-header">
            <h5 class="modal-title" id="accountModalLabel">å¸³è™Ÿç®¡ç†</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="username" class="form-label">å¸³è™Ÿ</label>
              <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">å¯†ç¢¼</label>
              <input type="password" class="form-control" id="password" required>
            </div>
            <div class="mb-2 text-muted small">è‹¥å¸³è™Ÿå·²å­˜åœ¨å‰‡é€²è¡Œå¯†ç¢¼è®Šæ›´ï¼Œå¦å‰‡æ–°å¢ã€‚</div>
          </div>
          <div class="modal-footer justify-content-between">
            <button type="submit" class="btn btn-primary">æ–°å¢/ç·¨è¼¯å¸³è™Ÿ</button>
            <button type="button" class="btn btn-outline-danger" onclick="deleteAcct()">åˆªé™¤æœ¬å¸³è™Ÿ</button>
          </div>          
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const teams = {{ contest_data.teams | tojson }};
  const positionMap = {};
  const rowsSet = new Set(), colsSet = new Set(), teamByPosition = {};
  // å°‡æ‰€æœ‰éšŠä¼çš„åº§ä½ä½ç½®å­˜å…¥ teamByPosition ç‰©ä»¶ä¸­
  $.each(teams, (id, team) => {
    const pos = team.position;
    var maxCol = 0;
    var maxRow = 0;
    if (pos && pos.length >= 2 && pos != "??") {
      const col = pos[0].toUpperCase();
      const row = parseInt(pos.slice(1));
      maxCol = Math.max(maxCol, col.charCodeAt(0) - 'A'.charCodeAt(0));
      maxRow = Math.max(maxRow, row - 1);
      rowsSet.add(row); colsSet.add(col);
      teamByPosition[pos] = team;
    }
    for(let i = 0; i <= maxCol; i++)
      if(!colsSet.has(String.fromCharCode('A'.charCodeAt(0) + i - 1)))
        colsSet.add(String.fromCharCode('A'.charCodeAt(0) + i - 1));
    for(let i = 0; i <= maxRow; i++)
      if(!rowsSet.has(i))
        rowsSet.add(i);
  });

  const rows = [...rowsSet].sort((a,b)=>a-b);
  const cols = [...colsSet].sort();

  $.each(rows, row => {
    const $tr = $('<tr style="border: 0;">');
    $.each(cols, col => {
      if(col && row){
        const pos = cols[col] + rows[row];
        const team = teamByPosition[pos];
        const div = $('<div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">').addClass('seat').attr('data-position', pos);
        if(team)
          div.addClass('occupied').html(`${team.name}`);
        else
          div.addClass('vaccant').html("-");
        const $td = $('<td style="padding: 0.1rem; border: 0;">').append(div);
        $('#seating-map').append($tr.append($td));
        positionMap[pos] = div[0];
      } else {
        if(col){ //row = 0
          const label = String.fromCharCode('A'.charCodeAt(0) + col - 1);
          const div = $('<div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">').addClass('seat-col-label').html(label);
          const $td = $('<td style="padding: 0.1rem; border: 0;">').append(div);
          $('#seating-map').append($tr.append($td));
        } else { //col = 0
          const label = (row?row:"@");
          const div = $('<div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">').addClass('seat-row-label').html(label);
          const $td = $('<td style="padding: 0.1rem; border: 0;" class="seat-row-label">').append(div);
          $('#seating-map').append($tr.append($td));
        } 
      }
    });
  });

  function highlightSeat(position) {
    $('.seat').removeClass('highlight');
    const seat = positionMap[position];
    if (seat) $(seat).addClass('highlight');
  }

  function updateStatus(id, field, value) {
    return $.ajax({
      url: "{{ url_for('api-update_status') }}",
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ id, field, value })
    });
  }

  function timeformat(time) {
    const hours = String(parseInt(time / 3600)).padStart(2, '0');
    const minutes = String(parseInt(time / 60) % 60).padStart(2, '0');
    const seconds = String(parseInt(time % 60)).padStart(2, '0');
    return `${hours}:${minutes}:${seconds}`;
  }

  function filter_all() {
    $('#runs-body tr').show();
    $('.fil_all').addClass('selected');
    $('.fil_sent').removeClass('selected');
    $('.fil_made').removeClass('selected');
  }
  function filter_sent() {
    $('#runs-body tr').show();
    $('#runs-body tr.run-sent').hide();
    $('.fil_all').removeClass('selected');
    $('.fil_sent').addClass('selected');
    $('.fil_made').removeClass('selected');
  }
  function filter_made() {
    $('#runs-body tr').show();
    $('#runs-body tr.run-made').hide();
    $('#runs-body tr.run-sent').hide();
    $('.fil_all').removeClass('selected');
    $('.fil_sent').removeClass('selected');
    $('.fil_made').addClass('selected');
  }
  // æ¸²æŸ“æ°£çƒè£½ä½œç‹€æ…‹
  function renderRuns() {
    $.getJSON("{{ url_for('api-runs_balloon') }}", function (res) {
      if(res.success != true){
        if(res.error == "NoPermission"){
          alert("è«‹é‡æ–°ç™»å…¥ã€‚");
          window.location.href = "{{ url_for('login') }}";
          return;
        }
        return
      }
      runs = res.data;
      const $tbody = $('#runs-body').empty();
      const selectedPositions = $('.seat.selected').map(function () {return $(this).data('position');}).get();
      const problemFirst = {};
      runs.reverse();
      $.each(runs, function (_, run) {
        if(run.team_position == "??") return true;
        const shouldShow = selectedPositions.length === 0 || selectedPositions.includes(run.team_position);
        const madeBtn = $('<button class="btn btn-sm">')
          .toggleClass('btn-warning', !run.made)
          .toggleClass('btn-success', run.made)
          .text(run.made ? 'ğŸ‰å·²å®Œæˆ' : 'ğŸ› ï¸å¾…è£½ä½œ')
          .click(() => {
            const msg = run.made ? 'è¦å›å¾©ç‚ºã€Œå¾…è£½ä½œã€å—ï¼Ÿ' : 'ç¢ºå®šå·²å®Œæˆè£½ä½œï¼Ÿ';
            if (!confirm(msg)) return;
            updateStatus(run.id, 'made', !run.made).then(renderRuns);
          });
        const sendBtn = $('<button class="btn btn-sm btn-primary">ğŸˆå¾…é€å‡º</button>')
          .text(run.sent ? 'ğŸ‰å·²é€å‡º' : 'ğŸˆå¾…é€å‡º')
          .toggleClass('btn-success', run.sent)
          .toggleClass('btn-primary', !run.sent)
          .prop('disabled', !run.made)
          .click(() => {
            if (!run.made) {
              alert('è«‹å…ˆå®Œæˆè£½ä½œæ°£çƒï¼');
              return;
            } else if(run.sent)
              return;
            const msg = 'ç¢ºå®šå·²é€å‡ºæ°£çƒï¼Ÿ';
            if (!confirm(msg)) return;
            updateStatus(run.id, 'sent', !run.sent).then(renderRuns);
          });
          let statusClass = '';
          if (!run.made && !run.sent)
            statusClass = 'run-pending';
          else if (run.made && !run.sent)
            statusClass = 'run-made';
          else if (run.made && run.sent)
            statusClass = 'run-sent';

          const $row = $(`
            <tr class="${statusClass}" data-position="${run.team_position}" style="font-weight: ${run.isFirst?"900":"normal"};">
              <td>${run.id}</td>
              <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 10vw;">${run.team_name}</td>
              <td>${run.team_section}</td>
              <td>${run.team_position}</td>
              <td>${run.problem_label + (run.isFirst?"é¦–æ®º":"")}</td>
              <td style="color:${run.color}; font-weight:bold; text-shadow: 0 0 2px #000;">${run.color}</td>
            </tr>
          `).on('mouseenter', () => highlightSeat(run.team_position))
            .on('mouseleave', () => $('.seat').removeClass('highlight'));

          $row.append($(`<td>`).append(madeBtn));
          $row.append($(`<td>`).append(sendBtn));
          $tbody.append($row);
      
          if(($(".fil_sent").hasClass("selected") && run.sent) || !shouldShow)
            $row.hide();
          if(($(".fil_made").hasClass("selected") && run.made) || !shouldShow)
            $row.hide();
          if($(".fil_all").hasClass("selected") || shouldShow)
            $row.show();
      });

      $("#balloon_rec").show();
      $("#loading").removeClass("d-flex").addClass("d-none");


      const contestTime = res.time.contestTime;
      const timestamp = res.time.timestamp;
      const remain = Math.max(0, contestTime - timestamp);
      $("#remaining-time").text(`å‰©é¤˜æ™‚é–“ï¼š${timeformat(remain)}`);
      if (remain <= 0)
        $("#remaining-time").removeClass("bg-success").removeClass("bg-warning").addClass("bg-danger");
      else if (remain <= 3600)
        $("#remaining-time").removeClass("bg-success").addClass("bg-warning").removeClass("bg-danger");
      else
        $("#remaining-time").addClass("bg-success").removeClass("bg-warning").removeClass("bg-danger");
    });
  }

  $(renderRuns);
  setInterval(renderRuns, 1000);

  $('#accountModal').on('show.bs.modal', function () {
    $('#username').val('{{ current_user }}');
    $('#password').val('');
  });

  $('#accountForm').on('submit', function (e) {
    e.preventDefault();
    const username = $('#username').val();
    const password = $('#password').val();
    $.ajax({
      url: "{{ url_for('api-account_modify') }}",
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ username, password }),
      success: function(response) {
        if(response.method == "add")
          alert('å¸³è™Ÿæ–°å¢æˆåŠŸï¼');
        else if(response.method == "edit")
          alert('å¸³è™Ÿç·¨è¼¯æˆåŠŸï¼');
        $('#accountModal').modal('hide');
      },
      error: function (xhr) {
          alert('å¸³è™Ÿæ–°å¢å¤±æ•—');
      }
    });
  });

  // åˆªé™¤å¸³è™ŸæŒ‰éˆ•è¡Œç‚º
  function deleteAcct() {
    if (confirm('ç¢ºå®šè¦åˆªé™¤ç›®å‰å¸³è™Ÿï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸ')) {
    $.post("{{ url_for('api-account_delete') }}")
      .done((res) => {
        alert('å¸³è™Ÿå·²åˆªé™¤ï¼Œå°‡ç™»å‡º...');
        window.location.href = "{{ url_for('login') }}";
      })
      .fail((response) => {
        res = response.responseJSON;
        if (res.error == "Not logged in") {
          alert("è«‹é‡æ–°ç™»å…¥ã€‚");
          window.location.href = "login";
        } else if (res.error == "Last account") {
          alert('ç„¡æ³•åˆªé™¤æœ€å¾Œä¸€å€‹å¸³è™Ÿï¼');
        } else if (res.error == "Account not found") {
          alert('å¸³è™Ÿä¸å­˜åœ¨ï¼');
        } else {
          alert('ç³»çµ±éŒ¯èª¤');
        }
      });
    }
  }

  function pollFrozenStatus() {
    $.getJSON("{{ url_for('api-frozen_get') }}", function (res) {
      const frozen = res.status;
      $('#frozenSwitch').prop('checked', (frozen == "True" ?"true": ""));
    });
  }
  $(pollFrozenStatus);
  setInterval(pollFrozenStatus, 1000); // æ¯ 2 ç§’æª¢æŸ¥ä¸€æ¬¡å‡çµç‹€æ…‹
  // ç”¨æˆ¶æ‰‹å‹•åˆ‡æ›å‡çµç‹€æ…‹
  $('#frozenSwitch').on('change', function (e) {
    const isChecked = $(this).prop('checked');
    const message = isChecked ? 'ç¢ºå®šè¦å°æ¿å—ï¼Ÿ' : 'ç¢ºå®šè¦é–‹æ¿å—ï¼Ÿ';
    // å–æ¶ˆåˆ‡æ›ï¼Œç­‰å¾…ä½¿ç”¨è€…ç¢ºèª
    e.preventDefault();
    $(this).prop('checked', !isChecked);

    if (confirm(message)) {
      $.ajax({
        url: "{{ url_for('api-frozen_post') }}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ frozen: isChecked }),
        success: res => {
          $('#frozenSwitch').prop('checked', res.frozen);
        },
        error: () => alert('åˆ‡æ›å¤±æ•—')
      });
    }
  });
  // é»æ“Šåº§ä½æ™‚ï¼Œé¡¯ç¤ºè©²éšŠä¼çš„è©³ç´°è³‡è¨Š
  // é»æ“Šåº§ä½ â†’ é¸å–ä¸¦ç¯©é¸å·¦å´æ°£çƒç´€éŒ„
  $('.seat.occupied').on('click', function () {
    $(this).toggleClass('selected'); // åˆ‡æ›é¸å–ç‹€æ…‹ï¼ˆæ”¯æ´å¤šé¸ï¼‰

    // æ”¶é›†æ‰€æœ‰è¢«é¸å–çš„ä½ç½®
    const selectedPositions = $('.seat.selected').map(function () {return $(this).data('position');}).get();

    // å¦‚æœæ²’æœ‰é¸æ“‡ä»»ä½•éšŠä¼ â†’ é¡¯ç¤ºå…¨éƒ¨
    if (selectedPositions.length === 0) {
      $('#runs-body tr').show();
      return;
    }

    // å¦å‰‡åªé¡¯ç¤ºé¸åˆ°çš„éšŠä¼ç´€éŒ„
    $('#runs-body tr').each(function () {
      const rowPos = $(this).data('position');
      if (selectedPositions.includes(rowPos)) {
        $(this).show();
      } else {
        $(this).hide();
      }
    });
  });

  function SelectReset() {
    $(".seat.occupied").removeClass("selected"); // æ¸…é™¤æ‰€æœ‰é¸å–ç‹€æ…‹
    $('#runs-body tr').show();
  }

</script>
</body>
</html>
